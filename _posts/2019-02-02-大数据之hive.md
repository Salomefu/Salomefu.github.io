---
layout: post
title: 大数据之hive
subtitle: 
date: 2019-02-02
author: Salome
header-img: img/post-bg-2015.jpg
catalog: true
tags:

   - big data


---

# 基本概念

Hive是基于Hadoop的一个数据仓库工具，可以将结构化的数据文件映射为一张表，并提供类SQL查询功能。

本质是：将HQL转化成MapReduce程序

![](https://tva1.sinaimg.cn/large/006tNbRwly1ga7nvbw03wj30wk0dwjvp.jpg)

1）Hive处理的数据存储在HDFS

2）Hive分析数据底层的实现是MapReduce

3）执行程序运行在Yarn上

##### 优点

1)   操作接口采用类SQL语法，提供快速开发的能力（简单、容易上手）。

2)   避免了去写MapReduce，减少开发人员的学习成本。

3)   Hive的执行延迟比较高，因此Hive常用于数据分析，对实时性要求不高的场合。

4)   Hive优势在于处理大数据，对于处理小数据没有优势，因为Hive的执行延迟比较高。

5)   Hive支持用户自定义函数，用户可以根据自己的需求来实现自己的函数。

##### 缺点

1）Hive的HQL表达能力有限

（1）迭代式算法无法表达

（2）数据挖掘方面不擅长，由于MapReduce数据处理流程的限制，效率更高的算法却无法实现。

2）Hive的效率比较低

（1）Hive自动生成的MapReduce作业，通常情况下不够智能化

（2）Hive调优比较困难，粒度较粗

  ##### 架构

![](https://tva1.sinaimg.cn/large/006tNbRwly1ga7o06esifj30ok0m6tbm.jpg)

1．用户接口：Client

CLI（command-line interface）、JDBC/ODBC(jdbc访问hive)、WEBUI（浏览器访问hive）

2．元数据：Metastore

元数据包括：表名、表所属的数据库（默认是default）、表的拥有者、列/分区字段、表的类型（是否是外部表）、表的数据所在目录等；

默认存储在自带的derby数据库中，推荐使用MySQL存储Metastore

3．Hadoop

使用HDFS进行存储，使用MapReduce进行计算。

4．驱动器：Driver

（1）解析器（SQL Parser）：将SQL字符串转换成抽象语法树AST，这一步一般都用第三方工具库完成，比如antlr；对AST进行语法分析，比如表是否存在、字段是否存在、SQL语义是否有误。

（2）编译器（Physical Plan）：将AST编译生成逻辑执行计划。

（3）优化器（Query Optimizer）：对逻辑执行计划进行优化。

（4）执行器（Execution）：把逻辑执行计划转换成可以运行的物理计划。对于Hive来说，就是MR/Spark。

##### 运行机制

![](https://tva1.sinaimg.cn/large/006tNbRwly1ga7oh70xcxj30t80cyn0e.jpg)

Hive通过给用户提供的一系列交互接口，接收到用户的指令(SQL)，使用自己的Driver，结合元数据(MetaStore)，将这些指令翻译成MapReduce，提交到Hadoop中执行，最后，将执行返回的结果输出到用户交互接口。

##### Hive和数据库比较

由于 Hive 采用了类似SQL 的查询语言 HQL(Hive Query Language)，因此很容易将 Hive 理解为数据库。其实从结构上来看，Hive 和数据库除了拥有类似的查询语言，再无类似之处。本文将从多个方面来阐述 Hive 和数据库的差异。数据库可以用在 Online 的应用中，但是Hive 是为数据仓库而设计的，清楚这一点，有助于从应用角度理解 Hive 的特性。

- 查询语言

由于SQL被广泛的应用在数据仓库中，因此，专门针对Hive的特性设计了类SQL的查询语言HQL。熟悉SQL开发的开发者可以很方便的使用Hive进行开发。

- 数据存储位置

Hive 是建立在 Hadoop 之上的，所有 Hive 的数据都是存储在 HDFS 中的。而数据库则可以将数据保存在块设备或者本地文件系统中。

- 数据更新

由于Hive是针对数据仓库应用设计的，而数据仓库的内容是读多写少的。因此，Hive中不建议对数据的改写，所有的数据都是在加载的时候确定好的。而数据库中的数据通常是需要经常进行修改的，因此可以使用 INSERT INTO … VALUES 添加数据，使用 UPDATE … SET修改数据。

- 执行

Hive中大多数查询的执行是通过 Hadoop 提供的 MapReduce 来实现的。而数据库通常有自己的执行引擎。

- 执行延迟

Hive 在查询数据的时候，由于没有索引，需要扫描整个表，因此延迟较高。另外一个导致 Hive 执行延迟高的因素是 MapReduce框架。由于MapReduce 本身具有较高的延迟，因此在利用MapReduce 执行Hive查询时，也会有较高的延迟。相对的，数据库的执行延迟较低。当然，这个低是有条件的，即数据规模较小，当数据规模大到超过数据库的处理能力的时候，Hive的并行计算显然能体现出优势。

- 可扩展性

由于Hive是建立在Hadoop之上的，因此Hive的可扩展性是和Hadoop的可扩展性是一致的（世界上最大的Hadoop 集群在 Yahoo!，2009年的规模在4000 台节点左右）。而数据库由于 ACID 语义的严格限制，扩展行非常有限。目前最先进的并行数据库 [Oracle](http://lib.csdn.net/base/oracle) 在理论上的扩展能力也只有100台左右。

- 数据规模

由于Hive建立在集群上并可以利用MapReduce进行并行计算，因此可以支持很大规模的数据；对应的，数据库可以支持的数据规模较小。

# 安装

##### Hive安装及配置

（1）把apache-hive-1.2.1-bin.tar.gz上传到linux的/opt/software目录下

（2）解压apache-hive-1.2.1-bin.tar.gz到/opt/module/目录下面

```
[root@hadoop100 software]$ tar -zxvf apache-hive-1.2.1-bin.tar.gz -C /opt/module/
```

（3）修改apache-hive-1.2.1-bin.tar.gz的名称为hive

```
[root@hadoop100 module]$ mv apache-hive-1.2.1-bin/ hive
```

（4）修改/opt/module/hive/conf目录下的hive-env.sh.template名称为hive-env.sh

```
[root@hadoop100 conf]$ mv hive-env.sh.template hive-env.sh
```

​    （5）配置hive-env.sh文件

​    （a）配置HADOOP_HOME路径

```
export HADOOP_HOME=/opt/module/hadoop-2.7.2
```

​    （b）配置HIVE_CONF_DIR路径

```
export HIVE_CONF_DIR=/opt/module/hive/conf
```

2．Hadoop集群配置

（1）必须启动hdfs和yarn

```
[root@hadoop100 hadoop-2.7.2]$ sbin/start-dfs.sh

[root@hadoop103 hadoop-2.7.2]$ sbin/start-yarn.sh
```

（2）在HDFS上创建/tmp和/user/hive/warehouse两个目录并修改他们的同组权限可写

```
[root@hadoop100 hadoop-2.7.2]$ bin/hadoop fs -mkdir /tmp

[root@hadoop100 hadoop-2.7.2]$ bin/hadoop fs -mkdir -p /user/hive/warehouse
```

```
[root@hadoop100 hadoop-2.7.2]$ bin/hadoop fs -chmod g+w /tmp

[root@hadoop100 hadoop-2.7.2]$ bin/hadoop fs -chmod g+w /user/hive/warehouse
```

3．Hive基本操作

（1）启动hive

```
[root@hadoop100 hive]$ bin/hive
```

（2）查看数据库

```
hive> show databases;
```

（3）打开默认数据库

```
hive> use default;
```

（4）显示default数据库中的表

```
hive> show tables;
```

（5）创建一张表

```
hive> create table student(id int, name string);
```

（6）显示数据库中有几张表

```
hive> show tables;
```

（7）查看表的结构

```
hive> desc student;
```

（8）向表中插入数据

```
hive> insert into student values(1000,"ss");
```

（9）查询表中数据

```
hive> select * from student;
```

（10）退出hive

```
hive> quit;
```

说明：（查看hive在hdfs中的结构）

数据库：在hdfs中表现为${hive.metastore.warehouse.dir}目录下一个文件夹

表：在hdfs中表现所属db目录下一个文件夹，文件夹中存放该表中的具体数据

##### 将本地文件导入Hive案例

需求

将本地/opt/module/datas/student.txt这个目录下的数据导入到hive的student(id int, name string)表中。

1．数据准备

在/opt/module/datas这个目录下准备数据

（1）在/opt/module/目录下创建datas

```
[root@hadoop100 module]$ mkdir datas
```

（2）在/opt/module/datas/目录下创建student.txt文件并添加数据

```
[root@hadoop100 datas]$ touch student.txt

[root@hadoop100 datas]$ vi student.txt

1001 zhangshan

1002 lishi

1003 zhaoliu
```

注意以tab键间隔。

2．Hive实际操作

（1）启动hive

```
[root@hadoop100 hive]$ bin/hive
```

（2）显示数据库

```
hive> show databases;
```

（3）使用default数据库

```
hive> use default;
```

（4）显示default数据库中的表

```
hive> show tables;
```

（5）删除已创建的student表

```
hive> drop table student;
```

（6）创建student表, 并声明文件分隔符’\t’

```
hive> create table student(id int, name string) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t';
```

（7）加载/opt/module/datas/student.txt 文件到student数据库表中。

```
hive> load data local inpath '/opt/module/datas/student.txt' into table student;
```

（8）Hive查询结果

```
hive> select * from student;

OK

1001 zhangshan

1002 lishi

1003 zhaoliu

Time taken: 0.266 seconds, Fetched: 3 row(s)
```

3．遇到的问题

再打开一个客户端窗口启动hive，会产生java.sql.SQLException异常。

原因是，Metastore默认存储在自带的derby数据库中，推荐使用MySQL存储Metastore;

##### MySql中user表中主机配置

配置只要是root用户+密码，在任何主机上都能登录MySQL数据库。

1．进入mysql

```
[root@hadoop100 mysql-libs]# mysql -uroot -p000000
```

2．显示数据库

```
mysql>show databases;
```

3．使用mysql数据库

```
mysql>use mysql;
```

4．展示mysql数据库中的所有表

```
mysql>show tables;
```

5．展示user表的结构

```
mysql>desc user;
```

6．查询user表

```
mysql>select User, Host, Password from user;
```

7．修改user表，把Host表内容修改为%

```
mysql>update user set host='%' where host='localhost';
```

8．删除root用户的其他host

```
mysql>delete from user where Host='hadoop100';

mysql>delete from user where Host='127.0.0.1';

mysql>delete from user where Host='::1';
```

9．刷新

```
mysql>flush privileges;
```

10．退出

```
mysql>quit;
```

##### Hive元数据配置到MySql

- 驱动拷贝

1．在/opt/software/mysql-libs目录下解压mysql-connector-java-5.1.27.tar.gz驱动包

```
[root@hadoop100 mysql-libs]# tar -zxvf mysql-connector-java-5.1.27.tar.gz
```

2．拷贝/opt/software/mysql-libs/mysql-connector-java-5.1.27目录下的mysql-connector-java-5.1.27-bin.jar到/opt/module/hive/lib/

```
[root@hadoop100 mysql-connector-java-5.1.27]# cp mysql-connector-java-5.1.27-bin.jar /opt/module/hive/lib/
```

- 配置Metastore到MySql

1．在/opt/module/hive/conf目录下创建一个hive-site.xml

```
[root@hadoop100 conf]$ touch hive-site.xml
[root@hadoop100 conf]$ vi hive-site.xml
```

2．根据官方文档配置参数，拷贝数据到hive-site.xml文件中

```xml
<?xml version="1.0"?>
<?xml-stylesheet type="text/xsl" href="configuration.xsl"?>
<configuration>
  <property>
   <name>javax.jdo.option.ConnectionURL</name>
   <value>jdbc:mysql://hadoop100:3306/metastore?createDatabaseIfNotExist=true</value>
   <description>JDBC connect string for a JDBC metastore</description>
  </property>
  <property>
   <name>javax.jdo.option.ConnectionDriverName</name>
   <value>com.mysql.jdbc.Driver</value>
   <description>Driver class name for a JDBC metastore</description>
  </property>
  <property>
   <name>javax.jdo.option.ConnectionUserName</name>
   <value>root</value>
   <description>username to use against metastore database</description>
  </property>
  <property>
   <name>javax.jdo.option.ConnectionPassword</name>
   <value>000000</value>
   <description>password to use against metastore database</description>
  </property>
</configuration>
```

3．配置完毕后，如果启动hive异常，可以重新启动虚拟机。（重启后，别忘了启动hadoop集群）

##### Hive常用交互命令

1．“-e”不进入hive的交互窗口执行sql语句

```
[root@hadoop100 hive]$ bin/hive -e "select id from student;"
```

2．“-f”执行脚本中sql语句

​    （1）在/opt/module/datas目录下创建hivef.sql文件

```
[root@hadoop100 datas]$ touch hivef.sql
```

​       文件中写入正确的sql语句 select *from student;

​    （2）执行文件中的sql语句

```
[root@hadoop100 hive]$ bin/hive -f /opt/module/datas/hivef.sql
```

（3）执行文件中的sql语句并将结果写入文件中

```
[root@hadoop100 hive]$ bin/hive -f /opt/module/datas/hivef.sql > /opt/module/datas/hive_result.txt
```

##### Hive常见属性配置

- Hive数据仓库位置配置

​    1）Default数据仓库的最原始位置是在hdfs上的：/user/hive/warehouse路径下。

​    2）在仓库目录下，没有对默认的数据库default创建文件夹。如果某张表属于default数据库，直接在数据仓库目录下创建一个文件夹。

​    3）修改default数据仓库原始位置（将hive-default.xml.template如下配置信息拷贝到hive-site.xml文件中）。

```xml
<property>
<name>hive.metastore.warehouse.dir</name>                <value>/user/hive/warehouse</value>  
<description>location of default database for  the warehouse
  </description>  
</property>  
```

配置同组用户有执行权限

```
bin/hdfs dfs -chmod g+w /user/hive/warehouse
```

- Hive运行日志信息配置

1．Hive的log默认存放在/tmp/root/hive.log目录下（当前用户名下）

2．修改hive的log存放日志到/opt/module/hive/logs

 （1）修改/opt/module/hive/conf/hive-log4j.properties.template文件名称为

hive-log4j.properties

```
[root@hadoop100 conf]$ pwd

/opt/module/hive/conf

[root@hadoop100 conf]$ mv hive-log4j.properties.template hive-log4j.properties
```

 （2）在hive-log4j.properties文件中修改log存放位置

```
hive.log.dir=/opt/module/hive/logs
```

- 参数配置方式

1．查看当前所有的配置信息

```
hive>set;
```

2．参数的配置三种方式

​    （1）配置文件方式

默认配置文件：hive-default.xml 

用户自定义配置文件：hive-site.xml

​    注意：用户自定义配置会覆盖默认配置。另外，Hive也会读入Hadoop的配置，因为Hive是作为Hadoop的客户端启动的，Hive的配置会覆盖Hadoop的配置。配置文件的设定对本机启动的所有Hive进程都有效。

（2）命令行参数方式

启动Hive时，可以在命令行添加-hiveconf param=value来设定参数。

例如：

```
[root@hadoop103 hive]$ bin/hive -hiveconf mapred.reduce.tasks=10;
```

注意：仅对本次hive启动有效

查看参数设置：

```
hive (default)> set mapred.reduce.tasks;
```

（3）参数声明方式

可以在HQL中使用SET关键字设定参数

例如：

```
hive (default)> set mapred.reduce.tasks=100;
```

注意：仅对本次hive启动有效。

查看参数设置

```
hive (default)> set mapred.reduce.tasks;
```

# 数据类型

##### 基本数据类型

| Hive数据类型 | Java数据类型 | 长度                                                 |                 例子                 |
| ------------ | ------------ | ---------------------------------------------------- | :----------------------------------: |
| TINYINT      | byte         | 1byte有符号整数                                      |                  20                  |
| SMALINT      | short        | 2byte有符号整数                                      |                  20                  |
| INT          | int          | 4byte有符号整数                                      |                  20                  |
| BIGINT       | long         | 8byte有符号整数                                      |                  20                  |
| BOOLEAN      | boolean      | 布尔类型，true或者false                              |              TRUE FALSE              |
| FLOAT        | float        | 单精度浮点数                                         |               3.14159                |
| DOUBLE       | double       | 双精度浮点数                                         |               3.14159                |
| STRING       | string       | 字符系列。可以指定字符集。可以使用单引号或者双引号。 | ‘now is the time’ “for all good men” |
| TIMESTAMP    |              | 时间类型                                             |                                      |
| BINARY       |              | 字节数组                                             |                                      |

##### 集合数据类型

| 数据类型 | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| STRUCT   | 和c语言中的struct类似，都可以通过“点”符号访问元素内容。例如，如果某个列的数据类型是STRUCT{first STRING, last STRING},那么第1个元素可以通过字段.first来引用。 |
| MAP      | MAP是一组键-值对元组集合，使用数组表示法可以访问数据。例如，如果某个列的数据类型是MAP，其中键->值对是’first’->’John’和’last’->’Doe’，那么可以通过字段名[‘last’]获取最后一个元素 |
| ARRAY    | 数组是一组具有相同类型和名称的变量的集合。这些变量称为数组的元素，每个数组元素都有一个编号，编号从零开始。例如，数组值为[‘John’,  ‘Doe’]，那么第2个元素可以通过数组名[1]进行引用。 |

# DDL数据定义

# DML数据操作

# 查询

# 函数

#  存储

# 优化

